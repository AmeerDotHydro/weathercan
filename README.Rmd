---
title: "README"
author: "Steffi LaZerte"
output: github_document
---

```{r, echo = FALSE}
library(envirocan)
library(dplyr)
```
[![Build Status](https://travis-ci.org/steffilazerte/envirocan.svg?branch=master)](https://travis-ci.org/steffilazerte/envirocan) [![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/steffilazerte/envirocan?branch=master&svg=true)](https://ci.appveyor.com/project/steffilazerte/envirocan)

# envirocan

This package is makes it easier to search for and download multiple months/years of historical weather data from Environment Canada website.

Bear in mind that these downloads can be fairly large and performing multiple, downloads may use up Environment Canada's bandwidth unecessarily. Try to stick to what you need.

## Installation

Use the `devtools` package to directly install R packages from github:

```{r, eval = FALSE}
install.packages("devtools") # If not already installed
devtools::install_github("steffilazerte/envirocan", ref = "v0.2.2") 
## For most recent release; Otherwise omit "ref = " to download most recent version
## Also making use of the tidyverse for data manipulations
library(dplyr)
```

## Basic usage:

To download data, you first need to know the `station_id` associated with the station you're interested in.

### Stations

`envirocan` includes a data frame called `stations` which includes a list of stations and their details (including `station_id`.

```{r}
head(stations)
```

You can look through this data frame directly, or you can use the `stations_search` function:

```{r}
stations_search("Kamloops", interval = "hour")
```

Time frame must be one of "hour", "day", or "month".

You can also search by proximity:

```{r}
stations_search(coords = c(50.667492, -120.329049), dist = 20, interval = "hour")
```

We can also perform more complex searches using `tidyverse` tools and use the resulting vector:
```{r search_crit}
BCstations <- stations %>%
  filter(prov %in% c("BC")) %>%
  filter(interval == "hour") %>%
  filter(lat > 49 & lat < 49.5) %>%
  filter(lon > -119 & lon < -116) %>%
  filter(start<=2002) %>%
  filter(end>=2016)

## weather() accepts numbers so we can create a vector to input into weather:
stn_vector <- BCstations$station_id 

```

### Weather

Once you have your `station_id`(s) you can download weather data:

```{r}
kam <- weather(station_ids = 51423, start = "2016-01-01", end = "2016-02-15")
                    
head(kam)

```

You can also download data from multiple stations at once:

```{r}
kam.pg <- weather(station_ids = c(48248, 51423), start = "2016-01-01", end = "2016-02-15")
                    
head(kam.pg)
```


And plot it:

```{r}
library(ggplot2)

ggplot(data = kam.pg, aes(x = time, y = temp, group = station_name, colour = station_name)) +
  theme(legend.position = "top") +
  geom_line()
```

Or you can use the vector created above: 

```{r vector_input}
stn_vec_df <- weather(station_ids = stn_vector, start = "2016-01-01", end = "2016-02-15")

head(stn_vec_df)
```

### Interpolate and add data
You can merge weather data with other data frames by linearly interprolating between points.

For example, using the included datasets:

```{r}
head(kamloops)
head(finches)

finches_temperature <- add_weather(data = finches, weather = kamloops, cols = "temp")
summary(finches_temperature)
head(finches_temperature)
```

By default, gaps of 2 hours (or two days, with a daily scale) will be interpolated over, but longer gaps will be filled with NAs. You can adjust this behaviour with `na_gap`. Note that as environment canada data is downloaded on an hourly scale, it makes no sense to apply `na_gap` values of less than 1.

```{r}
finches_temperature <- add_weather(data = finches, weather = kamloops, cols = "temp", na_gap = 1)
summary(finches_temperature)

finches_temperature[is.na(finches_temperature$temp),][1:10,]
kamloops[is.na(kamloops$temp), c("time", "temp")]
```

