<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using with the tidyverse • weathercan</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<meta property="og:title" content="Using with the tidyverse">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">weathercan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../../articles/weathercan.html">Getting Started</a>
</li>
<li>
  <a href="http://steffilazerte.github.io/Presentations/#weathercan">Presentations</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/index.html">All Articles</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Tutorials</li>
    <li>
      <a href="../../articles/interpolate_data.html">Interpolating</a>
    </li>
    <li>
      <a href="../../articles/articles/use_with_tidyverse.html">Using weathercan with the tidyverse</a>
    </li>
    <li>
      <a href="../../articles/articles/mapping.html">Mapping weather data</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Reference vignetts</li>
    <li>
      <a href="../../articles/flags.html">Data flags</a>
    </li>
    <li>
      <a href="../../articles/glossary.html">Glossary of units and measurements</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/weathercan">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using with the tidyverse</h1>
                        <h4 class="author">Sam Albers</h4>
            
            <h4 class="date">2020-01-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/weathercan/blob/master/vignettes/articles/use_with_tidyverse.Rmd"><code>vignettes/articles/use_with_tidyverse.Rmd</code></a></small>
      <div class="hidden name"><code>use_with_tidyverse.Rmd</code></div>

    </div>

    
    
<div id="source-material" class="section level2">
<h2 class="hasAnchor">
<a href="#source-material" class="anchor"></a>Source material</h2>
<p>This vignette is adapted very heavily from Hadley Wickham’s incredible <a href="http://r4ds.had.co.nz/"><em>R for Data Science</em></a> book. You should support Hadley and the work he does by buying <a href="https://www.amazon.com/Data-Science-Transform-Visualize-Model/dp/1491910399">it</a>.</p>
</div>
<div id="packages" class="section level2">
<h2 class="hasAnchor">
<a href="#packages" class="anchor"></a>Packages</h2>
<p>In addition to <em>weathercan</em>, you’ll need several packages from the <em>tidyverse</em> to complete the following analysis.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(weathercan)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyr)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(broom)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(modelr)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(purrr)</a></code></pre></div>
</div>
<div id="using-weathercan-to-load-in-data" class="section level2">
<h2 class="hasAnchor">
<a href="#using-weathercan-to-load-in-data" class="anchor"></a>Using weathercan to load in data</h2>
<p>Your first decision that you need to make when analyzing data from weather stations across canada is to determine for which stations you’d like to query from Environment and Climate Change Canada. In this example, to keep processing time low, we will query two stations with very long records that happen to be far apart. To make that choice we can use (tidyverse)[<a href="http://tidyverse.org/" class="uri">http://tidyverse.org/</a>] tools and the included <code>stations</code> data frame in this package:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">stations <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(station_id <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">707</span>, <span class="dv">4859</span>, <span class="dv">6693</span>,<span class="dv">5397</span>, <span class="dv">2315</span>),</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">         interval <span class="op">==</span><span class="st"> "day"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(prov, station_name, station_id, start, end)</a></code></pre></div>
<pre><code>## # A tibble: 5 x 5
##   prov  station_name     station_id start   end
##   &lt;chr&gt; &lt;chr&gt;                 &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1 AB    TABER                  2315  1907  2019
## 2 BC    AGASSIZ CDA             707  1889  2019
## 3 NL    PORT AUX BASQUES       6693  1909  2017
## 4 ON    BELLEVILLE             4859  1866  2019
## 5 QC    LENNOXVILLE            5397  1888  2019</code></pre>
<p>These two weather stations will be our test data for this vignette. You can broaden or expand your analysis by choosing different or more station. Our next step is to use the <code><a href="../../reference/weather_dl.html">weather_dl()</a></code> function to load in the data.</p>
<p>The following will take quite some time to download as it is downloading over 100 years of daily data for 5 stations.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">pancan_df &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/weather_dl.html">weather_dl</a></span>(<span class="dt">station_ids =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">707</span>, <span class="dv">4859</span>, <span class="dv">6693</span>,<span class="dv">5397</span>, <span class="dv">2315</span>), </a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                        <span class="dt">interval =</span> <span class="st">"day"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(year <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1920</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(station_name, station_id, prov, lat, lon, elev, climate_id, WMO_id, TC_id, mean_temp, date)</a></code></pre></div>
</div>
<div id="plot-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-the-data" class="anchor"></a>Plot the data</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(pancan_df, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> date, <span class="dt">y =</span> mean_temp, <span class="dt">colour =</span> station_name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>()</a></code></pre></div>
<pre><code>## Warning: Removed 27049 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 7663 rows containing missing values (geom_path).</code></pre>
<p><img src="use_with_tidyverse_files/figure-html/raw_plt-1.png" width="960"></p>
<p>This is quite a large dataset.</p>
</div>
<div id="creating-list-columns" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-list-columns" class="anchor"></a>Creating list-columns</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">pancan_df_nest &lt;-<span class="st"> </span>pancan_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(station_name, station_id, prov, lat, lon, elev, climate_id, WMO_id, TC_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span>()</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">pancan_df_nest</a></code></pre></div>
<pre><code>## # A tibble: 5 x 10
## # Groups:   station_name, station_id, prov, lat, lon, elev, climate_id, WMO_id,
## #   TC_id [5]
##   station_name station_id prov    lat    lon  elev climate_id WMO_id TC_id
##   &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;
## 1 AGASSIZ CDA         707 BC     49.2 -122.   15   1100120    ""     ""   
## 2 BELLEVILLE         4859 ON     44.2  -77.4  76.2 6150689    ""     ""   
## 3 PORT AUX BA…       6693 NL     47.6  -59.2  39.7 8402975    71197  WZB  
## 4 LENNOXVILLE        5397 QC     45.4  -71.8 181   7024280    71611  WQH  
## 5 TABER              2315 AB     49.8 -112.  811   3036360    ""     ""   
## # … with 1 more variable: data &lt;list&lt;df[,2]&gt;&gt;</code></pre>
</div>
<div id="fit-some-models" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-some-models" class="anchor"></a>Fit some models</h2>
<p>Define the model</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">clim_model &lt;-<span class="st"> </span><span class="cf">function</span>(df) {</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(mean_temp <span class="op">~</span><span class="st"> </span>date, <span class="dt">data =</span> df)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">}</a></code></pre></div>
<p>Run the model with the existing data</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">pancan_df_nest &lt;-<span class="st"> </span>pancan_df_nest <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">model =</span> <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(data, clim_model))</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">pancan_df_nest</a></code></pre></div>
<pre><code>## # A tibble: 5 x 11
## # Groups:   station_name, station_id, prov, lat, lon, elev, climate_id, WMO_id,
## #   TC_id [5]
##   station_name station_id prov    lat    lon  elev climate_id WMO_id TC_id
##   &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;
## 1 AGASSIZ CDA         707 BC     49.2 -122.   15   1100120    ""     ""   
## 2 BELLEVILLE         4859 ON     44.2  -77.4  76.2 6150689    ""     ""   
## 3 PORT AUX BA…       6693 NL     47.6  -59.2  39.7 8402975    71197  WZB  
## 4 LENNOXVILLE        5397 QC     45.4  -71.8 181   7024280    71611  WQH  
## 5 TABER              2315 AB     49.8 -112.  811   3036360    ""     ""   
## # … with 2 more variables: data &lt;list&lt;df[,2]&gt;&gt;, model &lt;list&gt;</code></pre>
<p>Then add the residuals to the model</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">pancan_df_nest &lt;-<span class="st"> </span>pancan_df_nest <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">model =</span> <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(data, clim_model),</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">         <span class="dt">resids =</span> <span class="kw"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span>(data, model, add_residuals)) </a>
<a class="sourceLine" id="cb13-4" data-line-number="4">pancan_df_nest</a></code></pre></div>
<pre><code>## # A tibble: 5 x 12
## # Groups:   station_name, station_id, prov, lat, lon, elev, climate_id, WMO_id,
## #   TC_id [5]
##   station_name station_id prov    lat    lon  elev climate_id WMO_id TC_id
##   &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;
## 1 AGASSIZ CDA         707 BC     49.2 -122.   15   1100120    ""     ""   
## 2 BELLEVILLE         4859 ON     44.2  -77.4  76.2 6150689    ""     ""   
## 3 PORT AUX BA…       6693 NL     47.6  -59.2  39.7 8402975    71197  WZB  
## 4 LENNOXVILLE        5397 QC     45.4  -71.8 181   7024280    71611  WQH  
## 5 TABER              2315 AB     49.8 -112.  811   3036360    ""     ""   
## # … with 3 more variables: data &lt;list&lt;df[,2]&gt;&gt;, model &lt;list&gt;, resids &lt;list&gt;</code></pre>
</div>
<div id="working-with-list-columns" class="section level2">
<h2 class="hasAnchor">
<a href="#working-with-list-columns" class="anchor"></a>Working with list-columns</h2>
<p>We can unnest the results then plot them</p>
<div id="unnest" class="section level3">
<h3 class="hasAnchor">
<a href="#unnest" class="anchor"></a><code>unnest()</code>
</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">resids &lt;-<span class="st"> </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(pancan_df_nest, resids)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">resids</a></code></pre></div>
<pre><code>## # A tibble: 182,650 x 14
## # Groups:   station_name, station_id, prov, lat, lon, elev, climate_id, WMO_id,
## #   TC_id [5]
##    station_name station_id prov    lat   lon  elev climate_id WMO_id TC_id
##    &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;
##  1 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  2 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  3 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  4 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  5 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  6 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  7 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  8 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  9 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
## 10 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
## # … with 182,640 more rows, and 5 more variables: data &lt;list&lt;df[,2]&gt;&gt;,
## #   model &lt;list&gt;, mean_temp &lt;dbl&gt;, date &lt;date&gt;, resid &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="dt">data =</span> resids, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, resid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">group =</span> station_name), <span class="dt">alpha =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="dv">3</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span><span class="st"> </span>station_name, <span class="dt">ncol =</span> <span class="dv">1</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 7663 rows containing missing values (geom_path).</code></pre>
<pre><code>## Warning: Removed 27049 rows containing missing values (geom_point).</code></pre>
<p><img src="use_with_tidyverse_files/figure-html/resid-1.png" width="960"></p>
</div>
<div id="using-broom" class="section level3">
<h3 class="hasAnchor">
<a href="#using-broom" class="anchor"></a>Using broom</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">glance_df &lt;-<span class="st"> </span>pancan_df_nest <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">glance =</span> <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(model, broom<span class="op">::</span>glance)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(glance, <span class="dt">.drop =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(station_name, prov, r.squared, p.value, AIC)</a></code></pre></div>
<pre><code>## Warning: The `.drop` argument of `unnest()` is deprecated as of tidyr 1.0.0.
## All list-columns are now preserved.
## This warning is displayed once per session.
## Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<table class="table">
<thead><tr class="header">
<th align="right">station_id</th>
<th align="right">lat</th>
<th align="right">lon</th>
<th align="right">elev</th>
<th align="left">climate_id</th>
<th align="left">WMO_id</th>
<th align="left">TC_id</th>
<th align="left">station_name</th>
<th align="left">prov</th>
<th align="right">r.squared</th>
<th align="right">p.value</th>
<th align="right">AIC</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">707</td>
<td align="right">49.24</td>
<td align="right">-121.76</td>
<td align="right">15.0</td>
<td align="left">1100120</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">AGASSIZ CDA</td>
<td align="left">BC</td>
<td align="right">0.0030139</td>
<td align="right">0.0000000</td>
<td align="right">234152.1</td>
</tr>
<tr class="even">
<td align="right">4859</td>
<td align="right">44.15</td>
<td align="right">-77.39</td>
<td align="right">76.2</td>
<td align="left">6150689</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">BELLEVILLE</td>
<td align="left">ON</td>
<td align="right">0.0026427</td>
<td align="right">0.0000000</td>
<td align="right">266384.5</td>
</tr>
<tr class="odd">
<td align="right">6693</td>
<td align="right">47.57</td>
<td align="right">-59.15</td>
<td align="right">39.7</td>
<td align="left">8402975</td>
<td align="left">71197</td>
<td align="left">WZB</td>
<td align="left">PORT AUX BASQUES</td>
<td align="left">NL</td>
<td align="right">0.0041296</td>
<td align="right">0.0000000</td>
<td align="right">178541.2</td>
</tr>
<tr class="even">
<td align="right">5397</td>
<td align="right">45.37</td>
<td align="right">-71.82</td>
<td align="right">181.0</td>
<td align="left">7024280</td>
<td align="left">71611</td>
<td align="left">WQH</td>
<td align="left">LENNOXVILLE</td>
<td align="left">QC</td>
<td align="right">0.0011085</td>
<td align="right">0.0000000</td>
<td align="right">279873.3</td>
</tr>
<tr class="odd">
<td align="right">2315</td>
<td align="right">49.79</td>
<td align="right">-112.12</td>
<td align="right">811.0</td>
<td align="left">3036360</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">TABER</td>
<td align="left">AB</td>
<td align="right">0.0003875</td>
<td align="right">0.0025623</td>
<td align="right">181533.1</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="looking-at-the-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#looking-at-the-predictions" class="anchor"></a>Looking at the predictions</h2>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">preds &lt;-<span class="st"> </span>pancan_df_nest <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">model =</span> <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(data, clim_model),</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">         <span class="dt">preds =</span> <span class="kw"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span>(data, model, add_predictions)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(preds)</a>
<a class="sourceLine" id="cb22-5" data-line-number="5">preds</a></code></pre></div>
<pre><code>## # A tibble: 182,650 x 15
## # Groups:   station_name, station_id, prov, lat, lon, elev, climate_id, WMO_id,
## #   TC_id [5]
##    station_name station_id prov    lat   lon  elev climate_id WMO_id TC_id
##    &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;
##  1 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  2 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  3 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  4 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  5 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  6 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  7 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  8 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
##  9 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
## 10 AGASSIZ CDA         707 BC     49.2 -122.    15 1100120    ""     ""   
## # … with 182,640 more rows, and 6 more variables: data &lt;list&lt;df[,2]&gt;&gt;,
## #   model &lt;list&gt;, resids &lt;list&gt;, mean_temp &lt;dbl&gt;, date &lt;date&gt;, pred &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="dt">data =</span> preds, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> date, <span class="dt">y =</span> mean_temp, <span class="dt">colour =</span> station_name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">y =</span> pred)) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span><span class="st"> </span>station_name, <span class="dt">scales =</span> <span class="st">"free_y"</span>, <span class="dt">ncol =</span> <span class="dv">1</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 27049 rows containing missing values (geom_point).</code></pre>
<p><img src="use_with_tidyverse_files/figure-html/pred-1.png" width="960"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#source-material">Source material</a></li>
      <li><a href="#packages">Packages</a></li>
      <li><a href="#using-weathercan-to-load-in-data">Using weathercan to load in data</a></li>
      <li><a href="#plot-the-data">Plot the data</a></li>
      <li><a href="#creating-list-columns">Creating list-columns</a></li>
      <li><a href="#fit-some-models">Fit some models</a></li>
      <li><a href="#working-with-list-columns">Working with list-columns</a></li>
      <li><a href="#looking-at-the-predictions">Looking at the predictions</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Steffi LaZerte.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
