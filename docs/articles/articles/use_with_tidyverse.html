<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using with the tidyverse • weathercan</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../jquery.sticky-kit.min.js"></script><script src="../../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../index.html">weathercan</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../articles/index.html">Articles</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/steffilazerte/weathercan">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Using with the tidyverse</h1>
                        <h4 class="author">Sam Albers</h4>
            
            <h4 class="date">2017-06-09</h4>
          </div>

    
    
<div class="contents">
<div id="source-material" class="section level2">
<h2 class="hasAnchor">
<a href="#source-material" class="anchor"></a>Source material</h2>
<p>This vignette is adapted very heavily from Hadley Wickham’s incredible <a href="http://r4ds.had.co.nz/"><em>R for Data Science</em></a> book. You should support Hadley and the work he does by buying <a href="https://www.amazon.com/Data-Science-Transform-Visualize-Model/dp/1491910399">it</a>.</p>
</div>
<div id="packages" class="section level2">
<h2 class="hasAnchor">
<a href="#packages" class="anchor"></a>Packages</h2>
<p>In addition to <em>weathercan</em>, you’ll need several packages from the <em>tidyverse</em> to complete the following analysis.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(weathercan)
<span class="kw">library</span>(tibble)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(tidyr)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(broom)
<span class="kw">library</span>(modelr)
<span class="kw">library</span>(purrr)</code></pre></div>
</div>
<div id="using-weathercan-to-load-in-data" class="section level2">
<h2 class="hasAnchor">
<a href="#using-weathercan-to-load-in-data" class="anchor"></a>Using weathercan to load in data</h2>
<p>Your first decision that you need to make when analyzing data from weather stations across canada is to determine for which stations you’d like to query from Environment and Climate Change Canada. In this example, to keep processing time low, we will query two stations with very long records that happen to be far apart. To make that choice we can use (tidyverse)[<a href="http://tidyverse.org/" class="uri">http://tidyverse.org/</a>] tools and the included <code>stations</code> data frame in this package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stations %&gt;%
<span class="st">  </span><span class="kw">filter</span>(station_id %in%<span class="st"> </span><span class="kw">c</span>(<span class="dv">707</span>, <span class="dv">4859</span>, <span class="dv">6693</span>,<span class="dv">5397</span>, <span class="dv">2315</span>),
         interval ==<span class="st"> "day"</span>) %&gt;%
<span class="st">  </span><span class="kw">select</span>(prov, station_name, station_id, start, end)</code></pre></div>
<pre><code>## # A tibble: 5 x 5
##     prov     station_name station_id start   end
##   &lt;fctr&gt;            &lt;chr&gt;     &lt;fctr&gt; &lt;int&gt; &lt;int&gt;
## 1     BC      AGASSIZ CDA        707  1889  2017
## 2     AB            TABER       2315  1907  2017
## 3     ON       BELLEVILLE       4859  1866  2017
## 4     QC      LENNOXVILLE       5397  1888  2017
## 5     NL PORT AUX BASQUES       6693  1909  2017</code></pre>
<p>These two weather stations will be our test data for this vignette. You can broaden or expand your analysis by choosing different or more station. Our next step is to use the <code><a href="../../reference/weather.html">weather()</a></code> function to load in the data.</p>
<p>The following will take quite some time to download as it is downloading over 100 years of daily data for 5 stations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pancan_df &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/weather.html">weather</a></span>(<span class="dt">station_ids =</span> <span class="kw">c</span>(<span class="dv">707</span>, <span class="dv">4859</span>, <span class="dv">6693</span>,<span class="dv">5397</span>, <span class="dv">2315</span>), 
                     <span class="dt">interval =</span> <span class="st">"day"</span>) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(year &gt;=<span class="st"> </span><span class="dv">1920</span>) %&gt;%
<span class="st">  </span><span class="kw">select</span>(station_name, station_id, prov, lat, lon, elev, climat_id, WMO_id, TC_id, mean_temp, date)</code></pre></div>
</div>
<div id="plot-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-the-data" class="anchor"></a>Plot the data</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(pancan_df, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> mean_temp, <span class="dt">colour =</span> station_name)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre></div>
<pre><code>## Warning: Removed 25074 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 6325 rows containing missing values (geom_path).</code></pre>
<p><img src="use_with_tidyverse_files/figure-html/raw_plt-1.png" width="960"></p>
<p>This is quite a large dataset.</p>
</div>
<div id="creating-list-columns" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-list-columns" class="anchor"></a>Creating list-columns</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pancan_df_nest &lt;-<span class="st"> </span>pancan_df %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(station_name, station_id, prov, lat, lon, elev, climat_id, WMO_id, TC_id) %&gt;%
<span class="st">  </span><span class="kw">nest</span>()
pancan_df_nest</code></pre></div>
<pre><code>## # A tibble: 5 x 10
##       station_name station_id   prov   lat     lon  elev climat_id WMO_id
##              &lt;chr&gt;      &lt;dbl&gt; &lt;fctr&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;     &lt;chr&gt;  &lt;chr&gt;
## 1      AGASSIZ CDA        707     BC 49.24 -121.76  15.0   1100120       
## 2       BELLEVILLE       4859     ON 44.15  -77.39  76.2   6150689       
## 3 PORT AUX BASQUES       6693     NL 47.57  -59.15  39.7   8402975  71197
## 4      LENNOXVILLE       5397     QC 45.37  -71.82 181.0   7024280  71611
## 5            TABER       2315     AB 49.79 -112.12 811.0   3036360       
## # ... with 2 more variables: TC_id &lt;chr&gt;, data &lt;list&gt;</code></pre>
</div>
<div id="fit-some-models" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-some-models" class="anchor"></a>Fit some models</h2>
<p>Define the model</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">clim_model &lt;-<span class="st"> </span>function(df) {
  <span class="kw">lm</span>(mean_temp ~<span class="st"> </span>date, <span class="dt">data =</span> df)
}</code></pre></div>
<p>Run the model with the existing data</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pancan_df_nest &lt;-<span class="st"> </span>pancan_df_nest %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="kw">map</span>(data, clim_model))
pancan_df_nest</code></pre></div>
<pre><code>## # A tibble: 5 x 11
##       station_name station_id   prov   lat     lon  elev climat_id WMO_id
##              &lt;chr&gt;      &lt;dbl&gt; &lt;fctr&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;     &lt;chr&gt;  &lt;chr&gt;
## 1      AGASSIZ CDA        707     BC 49.24 -121.76  15.0   1100120       
## 2       BELLEVILLE       4859     ON 44.15  -77.39  76.2   6150689       
## 3 PORT AUX BASQUES       6693     NL 47.57  -59.15  39.7   8402975  71197
## 4      LENNOXVILLE       5397     QC 45.37  -71.82 181.0   7024280  71611
## 5            TABER       2315     AB 49.79 -112.12 811.0   3036360       
## # ... with 3 more variables: TC_id &lt;chr&gt;, data &lt;list&gt;, model &lt;list&gt;</code></pre>
<p>Then add the residuals to the model</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pancan_df_nest &lt;-<span class="st"> </span>pancan_df_nest %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="kw">map</span>(data, clim_model),
         <span class="dt">resids =</span> <span class="kw">map2</span>(data, model, add_residuals)) 
pancan_df_nest</code></pre></div>
<pre><code>## # A tibble: 5 x 12
##       station_name station_id   prov   lat     lon  elev climat_id WMO_id
##              &lt;chr&gt;      &lt;dbl&gt; &lt;fctr&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;     &lt;chr&gt;  &lt;chr&gt;
## 1      AGASSIZ CDA        707     BC 49.24 -121.76  15.0   1100120       
## 2       BELLEVILLE       4859     ON 44.15  -77.39  76.2   6150689       
## 3 PORT AUX BASQUES       6693     NL 47.57  -59.15  39.7   8402975  71197
## 4      LENNOXVILLE       5397     QC 45.37  -71.82 181.0   7024280  71611
## 5            TABER       2315     AB 49.79 -112.12 811.0   3036360       
## # ... with 4 more variables: TC_id &lt;chr&gt;, data &lt;list&gt;, model &lt;list&gt;,
## #   resids &lt;list&gt;</code></pre>
</div>
<div id="working-with-list-columns" class="section level2">
<h2 class="hasAnchor">
<a href="#working-with-list-columns" class="anchor"></a>Working with list-columns</h2>
<p>We can unnest the results then plot them</p>
<div id="unnest" class="section level3">
<h3 class="hasAnchor">
<a href="#unnest" class="anchor"></a><code>unnest()</code>
</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">resids &lt;-<span class="st"> </span><span class="kw">unnest</span>(pancan_df_nest, resids)
resids</code></pre></div>
<pre><code>## # A tibble: 177,945 x 12
##    station_name station_id   prov   lat     lon  elev climat_id WMO_id
##           &lt;chr&gt;      &lt;dbl&gt; &lt;fctr&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;     &lt;chr&gt;  &lt;chr&gt;
##  1  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  2  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  3  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  4  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  5  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  6  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  7  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  8  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  9  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
## 10  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
## # ... with 177,935 more rows, and 4 more variables: TC_id &lt;chr&gt;,
## #   mean_temp &lt;dbl&gt;, date &lt;date&gt;, resid &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> resids, <span class="kw">aes</span>(date, resid)) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> station_name), <span class="dt">alpha =</span> <span class="dv">1</span> /<span class="st"> </span><span class="dv">3</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>station_name, <span class="dt">ncol =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## Warning: Removed 6325 rows containing missing values (geom_path).</code></pre>
<pre><code>## Warning: Removed 25074 rows containing missing values (geom_point).</code></pre>
<p><img src="use_with_tidyverse_files/figure-html/resid-1.png" width="960"></p>
</div>
<div id="using-broom" class="section level3">
<h3 class="hasAnchor">
<a href="#using-broom" class="anchor"></a>Using broom</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">glance_df &lt;-<span class="st"> </span>pancan_df_nest %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">glance =</span> <span class="kw">map</span>(model, broom::glance)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(glance, <span class="dt">.drop =</span> <span class="ot">TRUE</span>) %&gt;%
<span class="st">  </span><span class="kw">select</span>(station_name, prov, r.squared, p.value, AIC)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">station_name</th>
<th align="left">prov</th>
<th align="right">r.squared</th>
<th align="right">p.value</th>
<th align="right">AIC</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">AGASSIZ CDA</td>
<td align="left">BC</td>
<td align="right">0.0022561</td>
<td align="right">0.0000000</td>
<td align="right">231433.5</td>
</tr>
<tr class="even">
<td align="left">BELLEVILLE</td>
<td align="left">ON</td>
<td align="right">0.0022103</td>
<td align="right">0.0000000</td>
<td align="right">259457.1</td>
</tr>
<tr class="odd">
<td align="left">PORT AUX BASQUES</td>
<td align="left">NL</td>
<td align="right">0.0033303</td>
<td align="right">0.0000000</td>
<td align="right">177849.2</td>
</tr>
<tr class="even">
<td align="left">LENNOXVILLE</td>
<td align="left">QC</td>
<td align="right">0.0009461</td>
<td align="right">0.0000000</td>
<td align="right">272731.9</td>
</tr>
<tr class="odd">
<td align="left">TABER</td>
<td align="left">AB</td>
<td align="right">0.0003139</td>
<td align="right">0.0071463</td>
<td align="right">178252.6</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="looking-at-the-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#looking-at-the-predictions" class="anchor"></a>Looking at the predictions</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">preds &lt;-<span class="st"> </span>pancan_df_nest %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="kw">map</span>(data, clim_model),
         <span class="dt">preds =</span> <span class="kw">map2</span>(data, model, add_predictions)) %&gt;%
<span class="st">  </span><span class="kw">unnest</span>(preds)
preds</code></pre></div>
<pre><code>## # A tibble: 177,945 x 12
##    station_name station_id   prov   lat     lon  elev climat_id WMO_id
##           &lt;chr&gt;      &lt;dbl&gt; &lt;fctr&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;     &lt;chr&gt;  &lt;chr&gt;
##  1  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  2  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  3  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  4  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  5  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  6  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  7  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  8  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
##  9  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
## 10  AGASSIZ CDA        707     BC 49.24 -121.76    15   1100120       
## # ... with 177,935 more rows, and 4 more variables: TC_id &lt;chr&gt;,
## #   mean_temp &lt;dbl&gt;, date &lt;date&gt;, pred &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> preds, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> mean_temp, <span class="dt">colour =</span> station_name)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> pred)) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>station_name, <span class="dt">scales =</span> <span class="st">"free_y"</span>, <span class="dt">ncol =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## Warning: Removed 25074 rows containing missing values (geom_point).</code></pre>
<p><img src="use_with_tidyverse_files/figure-html/pred-1.png" width="960"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#source-material">Source material</a></li>
      <li><a href="#packages">Packages</a></li>
      <li><a href="#using-weathercan-to-load-in-data">Using weathercan to load in data</a></li>
      <li><a href="#plot-the-data">Plot the data</a></li>
      <li><a href="#creating-list-columns">Creating list-columns</a></li>
      <li><a href="#fit-some-models">Fit some models</a></li>
      <li><a href="#working-with-list-columns">Working with list-columns</a></li>
      <li><a href="#looking-at-the-predictions">Looking at the predictions</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by LaZerte Stefanie E..</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
